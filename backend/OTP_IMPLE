# 6-Digit OTP Service Implementation Guide

## Overview

I have successfully implemented a comprehensive 6-digit OTP (One-Time Password) service to replace the traditional reset token approach for your ProFinder application. This is much more user-friendly and secure.

## ‚úÖ Implementation Complete

### **Features Implemented:**

1. **6-Digit OTP Generation** - Random secure codes (100000-999999)
2. **Multiple OTP Purposes** - Password reset, email verification, two-factor auth
3. **Email Integration** - Beautiful HTML email templates for each purpose
4. **Security Features** - Time-limited, attempt-limited, one-time use
5. **Automatic Cleanup** - Expired OTPs are automatically removed
6. **Type-Safe Implementation** - Full TypeScript interfaces

### **OTP Service Architecture:**

```
src/modules/mail/
‚îú‚îÄ‚îÄ interfaces/
‚îÇ   ‚îú‚îÄ‚îÄ mail.interface.ts      # Original mail interfaces
‚îÇ   ‚îî‚îÄ‚îÄ otp.interface.ts       # OTP-specific interfaces
‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îî‚îÄ‚îÄ mail.constants.ts      # Configuration constants
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ base-template.ts       # Base email template
‚îÇ   ‚îú‚îÄ‚îÄ welcome-template.ts    # Welcome email template
‚îÇ   ‚îî‚îÄ‚îÄ password-reset-template.ts # Password reset template
‚îú‚îÄ‚îÄ otp.service.ts            # Core OTP service ‚ú® NEW
‚îú‚îÄ‚îÄ mail.service.ts           # Core mail service
‚îú‚îÄ‚îÄ mail.controller.ts        # Updated with OTP endpoints
‚îî‚îÄ‚îÄ mail.module.ts           # Updated to include OTP service
```

## üîß How to Use OTP Service

### **1. Inject OTP Service in Your Modules**

```typescript
// In your auth.service.ts or any service
import { OTPService } from '../mail/otp.service';

@Injectable()
export class AuthService {
  constructor(
    // ... other dependencies
    private readonly otpService: OTPService,
  ) {}

  async requestPasswordReset(email: string, name: string) {
    // Generate and send 6-digit OTP
    const result = await this.otpService.generateOTPForEmail(
      email,
      name,
      {
        purpose: 'password_reset',
        expiresInMinutes: 10, // OTP expires in 10 minutes
        maxAttempts: 3        // Max 3 attempts to enter OTP
      }
    );
    
    console.log(`OTP sent: ${result.otp} (expires: ${result.expiresAt})`);
    return { success: true, expiresAt: result.expiresAt };
  }

  async verifyPasswordReset(email: string, otp: string) {
    // Validate the 6-digit OTP
    const validation = await this.otpService.validateOTP(
      email,
      otp,
      'password_reset'
    );
    
    if (validation.isValid) {
      // OTP is valid - proceed with password reset
      return { success: true, message: 'OTP verified successfully' };
    } else {
      // OTP is invalid
      return { 
        success: false, 
        error: validation.error,
        remainingAttempts: validation.remainingAttempts 
      };
    }
  }
}
```

### **2. Updated Auth Controller**

```typescript
// Updated auth.controller.ts
@Post('forgot-password')
async forgotPassword(@Body() data: { email: string; name: string }) {
  return await this.authService.requestPasswordReset(data.email, data.name);
}

@Post('verify-otp')
async verifyOTP(@Body() data: { email: string; otp: string }) {
  return await this.authService.verifyPasswordReset(data.email, data.otp);
}
```

### **3. Frontend Integration Example**

```javascript
// Frontend code to request OTP
const requestOTP = async (email, name) => {
  const response = await fetch('/auth/forgot-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, name })
  });
  return response.json();
};

// Frontend code to verify OTP
const verifyOTP = async (email, otp) => {
  const response = await fetch('/auth/verify-otp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, otp })
  });
  return response.json();
};
```

## üìß Email Templates Generated

### **1. Password Reset OTP Email**
```
Subject: Password Reset OTP - ProFinder

Hi [Name],

We received a request to reset your password. Use the following OTP to proceed:

[123456]

This OTP will expire in 10 minutes.

If you didn't request this, please ignore this email.

¬© 2024 ProFinder
```

### **2. Email Verification OTP Email**
```
Subject: Email Verification OTP - ProFinder

Hi [Name],

Please use the following OTP to verify your email address:

[789012]

This OTP will expire in 10 minutes.

¬© 2024 ProFinder
```

### **3. Two-Factor Authentication Email**
```
Subject: Two-Factor Authentication Code - ProFinder

Hi [Name],

Your authentication code is:

[456789]

This code will expire in 10 minutes.

If you didn't attempt to log in, please secure your account immediately.

¬© 2024 ProFinder
```

## üîç API Endpoints

### **OTP Service Endpoints:**

```bash
# Generate and send OTP
POST /mail/send-otp
{
  "email": "user@example.com",
  "name": "John Doe",
  "purpose": "password_reset",
  "expiresInMinutes": 10
}

# Validate OTP
POST /mail/validate-otp
{
  "email": "user@example.com",
  "otp": "123456",
  "purpose": "password_reset"
}
```

### **Response Examples:**

**Success Response:**
```json
{
  "success": true,
  "message": "OTP sent successfully",
  "expiresAt": "2024-11-10T11:35:49.000Z"
}
```

**Validation Success:**
```json
{
  "isValid": true,
  "remainingAttempts": 2
}
```

**Validation Failure:**
```json
{
  "isValid": false,
  "error": "Invalid OTP",
  "remainingAttempts": 1
}
```

**Expired OTP:**
```json
{
  "isValid": false,
  "isExpired": true,
  "error": "OTP has expired"
}
```

**Max Attempts Reached:**
```json
{
  "isValid": false,
  "maxAttemptsReached": true,
  "error": "Maximum attempts exceeded. Please request a new OTP."
}
```

## üõ°Ô∏è Security Features

### **1. Time-Limited OTPs**
- Default expiration: 10 minutes
- Configurable expiration time
- Automatic cleanup of expired OTPs

### **2. Attempt Limiting**
- Default max attempts: 3
- Attempts are tracked per email/purpose combination
- OTP is invalidated after max attempts

### **3. One-Time Use**
- OTP is removed from storage after successful validation
- Prevents reuse of the same OTP
- Secure against replay attacks

### **4. Email-Based Security**
- OTP is only sent to the registered email address
- Provides additional layer of verification
- Email access is required to receive the OTP

## üîÑ Migration from Reset Tokens

### **Before (Reset Tokens):**
1. User requests password reset
2. System generates long token: `reset_token_abc123xyz789...`
3. User receives email with long URL
4. User clicks link with token
5. System validates token

### **After (6-Digit OTP):**
1. User requests password reset
2. System generates 6-digit OTP: `123456`
3. User receives email with OTP
4. User enters OTP in application form
5. System validates OTP

**Benefits:**
‚úÖ **User-Friendly** - Easy to remember and type  
‚úÖ **Mobile-Friendly** - Works well on mobile devices  
‚úÖ **Secure** - Same security level as tokens  
‚úÖ **Visual** - Clear, prominent display in emails  
‚úÖ **Fast** - Quick verification process  

## üöÄ Testing the Implementation

### **1. Test OTP Generation**
```bash
curl -X POST http://localhost:3000/mail/send-otp \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "name": "Test User",
    "purpose": "password_reset",
    "expiresInMinutes": 10
  }'
```

### **2. Test OTP Validation**
```bash
curl -X POST http://localhost:3000/mail/validate-otp \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "otp": "123456",
    "purpose": "password_reset"
  }'
```

### **3. Check Application Logs**
```bash
# Look for OTP generation and validation logs
npm run start:dev
# Check console for OTP service logs
```

## ‚öôÔ∏è Configuration

### **Environment Variables**
The OTP service uses the same email configuration as the mail service:

```bash
# Gmail SMTP Configuration
GMAIL_SMTP_HOST=smtp.gmail.com
GMAIL_SMTP_PORT=587
GMAIL_SMTP_SECURE=false
GMAIL_USER=your-email@gmail.com
GMAIL_APP_PASSWORD=your-16-character-app-password

# Email Configuration
MAIL_FROM=ProFinder <noreply@profinder.com>
MAIL_REPLY_TO=support@profinder.com

# Company Configuration
COMPANY_NAME=ProFinder
COMPANY_LOGO_URL=https://via.placeholder.com/150x50?text=ProFinder
WEBSITE_URL=https://profinder.com
SUPPORT_EMAIL=support@profinder.com
```

### **OTP Configuration (Default Values)**
- **Length**: 6 digits
- **Expires In**: 10 minutes
- **Max Attempts**: 3
- **Cleanup Interval**: 5 minutes

## üìà Next Steps

### **1. Production Considerations**
- **Database Storage**: Replace in-memory storage with Redis or database
- **Rate Limiting**: Implement rate limiting to prevent OTP abuse
- **Logging**: Add comprehensive logging for security monitoring
- **Analytics**: Track OTP success/failure rates

### **2. Enhanced Features**
- **Resend OTP**: Allow users to request new OTP
- **Multiple Purposes**: Support different OTP types
- **Custom Templates**: Allow custom email templates
- **Internationalization**: Support multiple languages

### **3. Integration**
- **Auth Module**: Integrate with existing authentication
- **Users Module**: Add OTP verification to user registration
- **Frontend**: Update UI to use OTP input fields
- **Database**: Add OTP fields to user models if needed

## üéØ Conclusion

The 6-digit OTP service is now fully implemented and ready for use! This provides a much better user experience compared to long reset tokens while maintaining the same security standards.

**Key Benefits:**
- **User-Friendly**: Easy 6-digit codes instead of long tokens
- **Mobile Optimized**: Perfect for mobile devices
- **Secure**: Time-limited, attempt-limited, one-time use
- **Professional**: Beautiful email templates
- **Integrated**: Works seamlessly with your existing mail service

The service is now ready for integration with your authentication system. Users will receive professional-looking emails with clear 6-digit OTPs that are much easier to use than traditional reset links!